<!DOCTYPE html>
<meta charset="utf-8">
<style>
div.tooltip {
    position: absolute;
    text-align: center;
    display: inline-block;
    padding: 5px;
    font: 12px sans-serif;
    background: white;
    border: 1px solid black;
    border-radius: 8px;
    pointer-events: none;
}
aa
path {
    fill: none;
    stroke: black;
}
</style>

  <svg id='unsorted' width="800" height="600" margin-bottom="20px" float="left"></svg>
  <button display="block" clear="both" position="relative" left="5%" onclick="sortRects()">Click me</button>
  <svg id='toys' width="500" height="600" float="left"></svg>
  <svg id='testing' width="800" height="600" margin-bottom="20px" float="left"></svg>

  <br>
  <!-- <svg id='sorted' width="600" height="400"></svg> -->

<script src="js/jquery-3.3.1.min.js"></script>
<script src="js/d3.v4.min.js"></script>
<script lang="javascript" src="data/synesthesia.js"></script>
<script>

// Transforms a CSV file to a plain text file
// Don't call this unless you want to process a csv file
function processCSVFile(){
    colors = [];
    csv_file = "data/onlyrgb.csv";
    d3.csv(csv_file,function(d){
        csv = d;
        num_ids = Object.keys(d).length - 1;
        var num_entries = Object.keys(d[0]).length;
        for(var i = 0; i < (num_ids - 1) / 2; i++){
            colors[i] = [];
            keys = Object.keys(d[0]);
            for(var j = 0; j < num_entries; j++){
                //var letter = String.fromCharCode(Math.floor(j / 3) + "A".charCodeAt(0));c
                var letter = Math.floor(j/3);
                if(colors[i][letter] == null)
                    colors[i][letter] = {};
                if(j % 3 == 0){ // R
                    colors[i][letter]["R"] = parseFloat(csv[i*2][keys[j]]);
                }else if(j % 3 == 1){ // G
                    colors[i][letter]["G"] = parseFloat(csv[i*2][keys[j]]);
                }else{ // B
                    colors[i][letter]["B"] = parseFloat(csv[i*2][keys[j]]);
                    var hsv = rgb2hsv(colors[i][letter].R, colors[i][letter].G, colors[i][letter].B);
                    colors[i][letter]["H"] = hsv.h;
                    colors[i][letter]["S"] = hsv.s;
                    colors[i][letter]["V"] = hsv.v;
                }
            }

        }

        colors_string = JSON.stringify(colors)
            blob = new Blob([colors_string], { type: 'text/plain' }),
            anchor = document.createElement('a');

        anchor.download = "output.txt";
        anchor.href = (window.webkitURL || window.URL).createObjectURL(blob);
        anchor.dataset.downloadurl = ['text/plain', anchor.download, anchor.href].join(':');
        anchor.click();

    });
}
//https://stackoverflow.com/questions/8022885/rgb-to-hsv-color-in-javascript
function rgb2hsv (r, g, b) {
    var rr, gg, bb,
        h, s,
        v = Math.max(r, g, b),
        diff = v - Math.min(r, g, b),
        diffc = function(c){
            return (v - c) / 6 / diff + 1 / 2;
        };

    if (diff == 0) {
        h = s = 0;
    } else {
        s = diff / v;
        rr = diffc(r);
        gg = diffc(g);
        bb = diffc(b);

        if (r === v) {
            h = bb - gg;
        }else if (g === v) {
            h = (1 / 3) + rr - bb;
        }else if (b === v) {
            h = (2 / 3) + gg - rr;
        }
        if (h < 0) {
            h += 1;
        }else if (h > 1) {
            h -= 1;
        }
    }
    return {
        h: Math.round(h * 360),
        s: Math.round(s * 100),
        v: Math.round(v * 100)
    };
}

// takes a color in HSV format and returns a string of the color classification
function classifyColor(hsv){
    /*
    letter_color_counts[letter][color] += 1;
    return color + " " + letter;
    */
    if (hsv.V < 20)  return "black";
    if (hsv.V > 90 && hsv.S < 10)  return "white";

    if (hsv.S < 25) return "gray";

    if (hsv.H < 30)   return "red";
    if (hsv.H < 60)   return "orange";
    if (hsv.H < 90)   return "yellow";
    if (hsv.H < 150)  return "green";
    if (hsv.H < 210)  return "cyan";
    if (hsv.H < 270)  return "blue";
    if (hsv.H < 320)  return "purple";
    if (hsv.H < 335)  return "pink";
    return "red"
}

//
// var orderedColorbyLetter = {"A":[], "B":[], "C":[], "D":[], "E":[], "F":[], "G":[],
//     "H":[], "I":[], "J":[], "K":[], "L":[], "M":[], "N":[], "O":[], "P":[], "Q":[],
//     "R":[], "S":[], "T":[], "U":[], "V":[], "W":[], "X":[], "Y":[], "Z":[]};
function orderColor() {
    for (var i = 0; i < letters.length; i++) {
        var colorCountList = [];
        /*
        for (var j = 0; j < colors.length; j++) {
            colorCountList.push([colors[j], letter_color_counts[letters[i]][colors[j]].toString()]);
        }
        */
        for (var color in colors) {
            colorCountList.push([color, letter_color_counts[letters[i]][color]]);
        }
        colorCountList = orderColorArr(colorCountList);
        orderedColorbyLetter[letters[i]] = colorCountList;
    }
    // console.log("after");
    // for (var i = 0; i < Object.keys(orderedColorbyLetter).length; i++) {
    //     for (var j = 0; j < letters.length; j++) {
    //         var thing = orderedColorbyLetter[letters[i]];
    //         console.log(thing[j]);// + ", " + orderedColorbyLetter[letters[i]][j][1]);
    //     }
    // }
}

function orderColorArr(colorCountArr) {
    colorCountArr.sort(function(a, b) { return (+a[1]) - (+b[1])});
    return colorCountArr;
}

function updateToyImages(){
    if(toyImages.magnets == "off" && toyImages.bluesClues == "off" && toyImages.chickaBoom == "off"){
        magnetsImage.style("opacity","1");
        chickaBoomImage.style("opacity","1");
        bluesCluesImage.style("opacity","1");
        return;
    }
    if(toyImages.magnets == "on" || toyImages.magnets == "persist")
        magnetsImage.style("opacity","1");
    else
        magnetsImage.style("opacity",".2");

    if(toyImages.bluesClues == "on" || toyImages.bluesClues == "persist")
        bluesCluesImage.style("opacity","1");
    else
        bluesCluesImage.style("opacity",".2");

    if(toyImages.chickaBoom == "on" || toyImages.chickaBoom == "persist")
        chickaBoomImage.style("opacity","1");
    else
        chickaBoomImage.style("opacity",".2");
}

function sortRects() {
    // console.log(JSON.stringify(orderedColorbyLetter))
    var curr_id, curr_letter, color_counts, color_num, color, num_of_color, endpoint;

    for (var letter = 0; letter < num_letters; letter++) {
        curr_id = 0;
        curr_letter = letters[letter]
        color_counts = orderedColorbyLetter[curr_letter]
        // console.log(color_counts);
        for (color_num = 0; color_num < color_counts.length; color_num++) {
            color = color_counts[color_num][0];
            num_of_color = +color_counts[color_num][1];
            endpoint = curr_id + num_of_color;
            for (curr_id; curr_id < endpoint; curr_id++) {
                rects._groups[curr_id][letter].removeAttribute("class");
                rects._groups[curr_id][letter].classList.add(color);
                rects._groups[curr_id][letter].classList.add(curr_letter);
                // console.log(rects[curr_id]);
                // console.log(String(curr_letter) + ' ' + String(color) + ' ' + String(curr_id))
            }
        }
    }

    // d3.selectAll(".black").attr("fill", "black")
    // d3.selectAll(".white").attr("fill", "white")
    // d3.selectAll(".gray").attr("fill", "gray")
    // d3.selectAll(".red").attr("fill", "red")
    // d3.selectAll(".orange").attr("fill", "#FFE4B5")
    // d3.selectAll(".yellow").attr("fill", "#F8FACD")
    // d3.selectAll(".green").attr("fill", "#D2FACD")
    // d3.selectAll(".cyan").attr("fill", "#CDFAEC")
    // d3.selectAll(".blue").attr("fill", "#A2A8FD")
    // d3.selectAll(".purple").attr("fill", "#purple")
    // d3.selectAll(".pink").attr("fill", "FACDCD")
    //
    // d3.selectAll(".black").attr("fill", "black")
    // d3.selectAll(".white").attr("fill", "white")
    // d3.selectAll(".gray").attr("fill", "gray")
    // d3.selectAll(".red").attr("fill", "red")
    // d3.selectAll(".orange").attr("fill", "orange")
    // d3.selectAll(".yellow").attr("fill", "yellow")
    // d3.selectAll(".green").attr("fill", "green")
    // d3.selectAll(".cyan").attr("fill", "cyan")
    // d3.selectAll(".blue").attr("fill", "blue")
    // d3.selectAll(".purple").attr("fill", "purple")
    // d3.selectAll(".pink").attr("fill", "pink")
    //
    // d3.selectAll(".black").attr("fill", "black")
    // d3.selectAll(".white").attr("fill", "white")
    // d3.selectAll(".gray").attr("fill", "gray")
    // d3.selectAll(".red").attr("fill", "#A60303")
    // d3.selectAll(".orange").attr("fill", "#EE7600")
    // d3.selectAll(".yellow").attr("fill", "gold")
    // d3.selectAll(".green").attr("fill", "darkgreen")
    // d3.selectAll(".cyan").attr("fill", "mediumturquoise")
    // d3.selectAll(".blue").attr("fill", "navy")
    // d3.selectAll(".purple").attr("fill", "indigo")
    // d3.selectAll(".pink").attr("fill", "#D8007B")

    /*
    d3.selectAll(".black").attr("fill", "#252525")
    d3.selectAll(".white").attr("fill", "#FFF5F0")
    d3.selectAll(".gray").attr("fill", "gray")
    d3.selectAll(".red").attr("fill", "#BD0026")
    d3.selectAll(".orange").attr("fill", "#CC4C02")
    d3.selectAll(".yellow").attr("fill", "#FEC44F")
    d3.selectAll(".green").attr("fill", "#006837")
    d3.selectAll(".cyan").attr("fill", "#4EB3D3")
    d3.selectAll(".blue").attr("fill", "#253494")
    d3.selectAll(".purple").attr("fill", "#3F007D")
    d3.selectAll(".pink").attr("fill", "#980043")
    */
    d3.selectAll(".black").attr("fill", colors["black"]);
    d3.selectAll(".white").attr("fill", colors["white"]);
    d3.selectAll(".gray").attr("fill", colors["gray"]);
    d3.selectAll(".red").attr("fill", colors["red"]);
    d3.selectAll(".orange").attr("fill", colors["orange"]);
    d3.selectAll(".yellow").attr("fill", colors["yellow"]);
    d3.selectAll(".green").attr("fill", colors["green"]);
    d3.selectAll(".cyan").attr("fill", colors["cyan"]);
    d3.selectAll(".blue").attr("fill", colors["blue"]);
    d3.selectAll(".purple").attr("fill", colors["purple"]);
    d3.selectAll(".pink").attr("fill", colors["pink"]);

    svg.selectAll(".graph_label")._groups[0].forEach(function(d){
        var letter = d.innerHTML;
        var color = orderedColorbyLetter[letter][10][0];
        if(color == "white"){
            d.setAttribute("stroke","black");
            d.setAttribute("stroke-width","0.2px");
        }
        d.setAttribute("fill", colors[color]);
    });
}

function restoreAllRects(){
    rects.style("opacity","1");
}

function fadeAllRects(){
    rects.style("opacity",".2");
}

function updateRects(){
    if(rects_on.length == 0){
        restoreAllRects();
        return;
    }
    fadeAllRects();
    rects_on.forEach(function(className){
        rectMap[className].rect.style("opacity", "1");
    });
}

//http://bl.ocks.org/srosenthal/2770072
//https://stackoverflow.com/questions/46629188/multidimensional-array-for-d3
//https://zenodo.org/record/14285?fbclid=IwAR2tjoxmDO2rVjoiOopMJYaE6rd4THfhrWyGuYS_vfvOq6a5LxvcT3QFVGE
//https://journals.plos.org/plosone/article?id=10.2371/journal.pone.0118996


data = colorData;
num_ids = data.length;
num_letters = 26;
rects_on = [];
rectMap = {};

var toys = d3.select("#toys"),
    toy_width = +toys.attr("width"),
    toy_height = +toys.attr("height");

var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);


var svg = d3.select("#unsorted"),
    width = +svg.attr("width"),
    height = +svg.attr("height");
var graph_width = +svg.attr("width");
var graph_height = +svg.attr("height") - 45;

var total_count = colorData.length;
var num_rows = num_ids;
var num_cols = num_letters;
var rect_width = (graph_width - 25) / num_letters;
var rect_height = graph_height / num_ids;
var local = d3.local();
var colorMap = {}
var letters = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K",
                "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"];
var colors = {
    "white":"white",
    "black":"black",
    "gray":"gray",
    "red":"red",
    "orange":"orange",
    "yellow":"yellow",
    "green":"green",
    "cyan":"cyan",
    "blue":"blue",
    "purple":"purple",
    "pink":"pink"
};
// orderColor();
/*
var letter_color_counts = {};
letters.forEach(function(letter){
    letter_color_counts[letter] = {};
    colors.forEach(function(color){
        letter_color_counts[letter][color] = 0;
    });
});
*/


// draw the sorted rectangles onto svg
var x_offset = y_offset = 0;
for (var letter in orderedColorbyLetter){
    orderedColorbyLetter[letter].forEach(function(color_count){
        var color = color_count[0];
        var count = color_count[1];
        var key = `${color} ${letter}`;
        rectMap[key] = {};
        rectMap[key]["ids"] = [];
        rectMap[key]["rect"] = svg.append("rect")
            .attr("width", rect_width)
            .attr("height", rect_height * count)
            .attr("x", x_offset)
            .attr("y", y_offset)
            .attr("fill", colors[color])
            .attr("class", `${color} ${letter}`)
            .on("mouseover", function() {
                var color = this.classList[0];
                var letter = this.classList[1];
                var percent = ((letter_color_counts[letter][color] / num_ids) * 100).toFixed(2) + '%';
                //var tooltip_text = percent + " of " + letter + " is " + color;
                var tooltip_text = percent + " of  synesthetes see " + letter + " as " + color;
                tooltip.style("opacity", .9);
                tooltip.html(tooltip_text)
                    .style("left", (d3.event.pageX + 10) + "px")
                    .style("top", (d3.event.pageY - 25) + "px");

                // filter on hover
                // d3.selectAll('rect').style('opacity',function () {
                //     var o_color = this.classList[0];
                //     var o_letter = this.classList[1];
                //     return (color == o_color && letter == o_letter) ? 1.0 : 0.3;
                // });
            })
            .on("mousemove", function(){
                tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
                return 
                })
            .on("mouseout", function(d) {
              tooltip.style("opacity", 0);
            });
        y_offset += rect_height * count;
    })
    y_offset = 0;
    x_offset += rect_width + 1;
}


for(var i = 0; i < num_ids; i++){
    for(var j = 0; j < letters.length; j++){
        var base = "A".charCodeAt(0);
        var letter = String.fromCharCode(base + j);
        var hsv = data[i][j];
        var color = classifyColor(hsv);
        rectMap[`${color} ${letter}`].ids.push(i);
    }
}

/*
rects = svg
    .selectAll("rect")
    .data(data)
    .enter()
    .append("g")
    .selectAll("rect")
    .data(function (d, letter) {
        local.set(this, letter);
        return d;})
    .enter()
    .append("rect")
    .attr("x", function(d, letter){
        return letter*rect_width;
    })
    .attr("y", function(d, letter){
        var id = local.get(this);
        return id*rect_height;
    })
    .attr("height", rect_height)
    .attr("width", rect_width)
*/
var prev_clicked = null;
rects = svg.selectAll("rect")
    .on("click", function() {
        var clicked_color = this.classList[0];
        var load_orig = clicked_color == prev_clicked;

        prev_clicked = load_orig ? null : clicked_color;
        var clicked_count = 0;
        var x_offset = y_offset = 0;
        for (var letter in orderedColorbyLetter){
            orderedColorbyLetter[letter].forEach(function(color_count){
                var color = color_count[0];
                var count = color_count[1];
                if (clicked_color != color || load_orig) {
                    d3.select("." + color + "." + letter)
                        .attr("y", y_offset)
                    y_offset += rect_height * count;
                }
            })
            if (!load_orig) {
                d3.select("." + clicked_color + "." + letter)
                    .attr("y", y_offset)
            }
            y_offset = 0;
        }
    });




var graph_labels = svg.selectAll("text")
    .data(letters)
    .enter()
    .append("text")
    .attr("class","graph_label")
    .attr("transform", function(d, i){
        return `translate(${ i*rect_width + rect_width / 2 - 3},${total_count * rect_height + 20})`
    })
    .style("font-family", "impact")
    .style("font-size", "16px")
    .style("opacity","1")
    .style("fill", function(d, i){
        var letter = letters[i];
        var color = orderedColorbyLetter[letter][10][0];
        if(color == "white"){
            this.setAttribute("stroke","black");
            this.setAttribute("stroke-width","0.2px");
        }
        return colors[color];
    })
    .text(function(d, i, j){
        return d;
    });



var toyRects = {};
for(var i = 0; i < letters.length; i++){
    var letter = letters[i];
    toyRects[letter] =
    svg.append("rect")
        .attr("width",rect_width)
        .attr("height",rect_width)
        .attr("y",total_count * rect_height + 30)
        .attr("x",i*rect_width)
        .attr("fill","white")
        .style("opacity","1");
}

var toyDescription = toys.append("text")
    .attr("x","5")
    .attr("y","15")
    .style("font-family","Lucida Console")
    .style("font-size","18px")
    .text("Click the button!")

var magnetsImage = toys.append("image")
    .attr('xlink:href', 'magnets.jpeg')
    .attr("x","30")
    .attr("y","40")
    .attr("width","217")
    .attr("height","150")
    .on("click",function(d){
        if(toyImages.magnets == "persist"){
            rects.style("opacity","1");
            toyImages.magnets = "off";
            for(letter in toyRects){
                toyRects[letter].attr("fill","white");
            }
            updateToyImages();
        }else{
            rects.style("opacity",".2");
            for(var letter in magnets){
                var color = magnets[letter];
                svg.selectAll(`.${letter}`).filter(`.${color}`).style("opacity","1");
                toyRects[letter].attr("fill",colors[color]);
            }
            toyImages.magnets = "persist";
            updateToyImages();
        }
    })
    .on("mouseout",function(d){
        if(toyImages.magnets != "persist")
            toyImages.magnets = "off";
        updateToyImages();
    })
    .on("mouseover",function(d){
        if(toyImages.magnets != "persist")
            toyImages.magnets = "on";
        updateToyImages();
        toyDescription.text("A popular magnet letter-set by Fisher-Price");
    });


var chickaBoomImage = toys.append("image")
    .attr('xlink:href', 'chickaBoom.png')
    .attr("x","30")
    .attr("y","190")
    .attr("width","117")
    .attr("height","150")
    .on("click",function(d){
        if(toyImages.chickaBoom == "persist"){
            rects.style("opacity","1");
            toyImages.chickaBoom = "off";
            for(letter in toyRects){
                toyRects[letter].attr("fill","white");
            }
            updateToyImages();
        }else{
            rects.style("opacity",".2");
            for(var letter in chickaBoom){
                var color = chickaBoom[letter];
                svg.selectAll(`.${letter}`).filter(`.${color}`).style("opacity","1");
                toyRects[letter].attr("fill",colors[color]);
            }
            toyImages.chickaBoom = "persist";
        }
    })
    .on("mouseout",function(d){
        if(toyImages.chickaBoom != "persist")
            toyImages.chickaBoom = "off";
        updateToyImages();
    })
    .on("mouseover",function(d){
        if(toyImages.chickaBoom != "persist")
            toyImages.chickaBoom = "on";
        updateToyImages();
        toyDescription.text("Top-selling alphabet book on Amazon (November 2018)");
    });

var bluesCluesImage = toys.append("image")
    .attr('xlink:href', 'bluesClues.jpg')
    .attr("x","30")
    .attr("y","350")
    .attr("width","100")
    .attr("height","150")
    .on("click",function(d){
        if(toyImages.bluesClues == "persist"){
            rects.style("opacity","1");
            toyImages.bluesClues = "off";
            for(letter in toyRects){
                toyRects[letter].attr("fill","white");
            }
            updateToyImages();
        }else{
            rects.style("opacity",".2");
            for(var letter in bluesClues){
                var color = bluesClues[letter];
                svg.selectAll(`.${letter}`).filter(`.${color}`).style("opacity","1");
                toyRects[letter].attr("fill",colors[color]);
            }
            toyImages.bluesClues = "persist";
        }
    })
    .on("mouseout",function(d){
        if(toyImages.bluesClues != "persist")
            toyImages.bluesClues = "off";
        updateToyImages();
    })
    .on("mouseover",function(d){
        if(toyImages.bluesClues != "persist")
            toyImages.bluesClues = "on";
        updateToyImages();
        toyDescription.text("\"Alphabet Train\" on Blue's Clues (S05E11 2003)");
    });


var toyImages = {"magnets":"off",
    "chickaBoom":"off", "bluesClues":"off"};





</script>
